#!/usr/bin/env bash

set -euo pipefail

# CNB buildpack specific variables
LAYERS_DIR="$1"
PLATFORM_DIR="$2"
APP_DIR="/workspace"

# Set layer directory path
LAYER_DIR="${LAYERS_DIR}/service-mesh"

# Read allowed environment variables from platform directory
if [ -f "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET" ]; then
    HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET=$(cat "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET")
    export HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET
fi

if [ -f "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION" ]; then
    HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION=$(cat "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION")
    export HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION
fi

BUILDPACK_DIR=$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)
source "${BUILDPACK_DIR:?}/lib/applink_installer.sh"

# Read cached ETag if available
CACHED_ETAG=""
if [ -f "${LAYER_DIR}.toml" ]; then
    CACHED_ETAG=$(grep "etag = " "${LAYER_DIR}.toml" | cut -d'"' -f2 2>/dev/null || echo "")
fi

# Install binary (handles cache checking internally)
if ! install_applink_binary "${LAYER_DIR}/bin" "$CACHED_ETAG"; then
    echo " !     Failed to install Heroku AppLink Service Mesh binary"
    exit 1
fi

# Create/update layer metadata
cat > "${LAYER_DIR}.toml" << EOL
[types]
launch = true
build = false
cache = true

[metadata]
etag = "${APPLINK_CURRENT_ETAG}"
EOL


# Read web process from Procfile
echo "-----> Reading web process from Procfile..."
if [ -f "${APP_DIR}/Procfile" ]; then
    WEB_COMMAND=$(grep "^web:" "${APP_DIR}/Procfile" | sed 's/^web: //' || echo "")
    if [ -z "$WEB_COMMAND" ]; then
        echo " !     No web process found in Procfile"
        echo " !     Please add the following to your Procfile:"
        echo " !     web: heroku-applink-service-mesh <your app startup command>"
    else
        # Check if web command already contains the binary name
        if [[ "$WEB_COMMAND" == *"heroku-applink-service-mesh"* ]]; then
            echo "       The web command contains the Heroku AppLink Service Mesh binary"
        else
            echo " !     The web command doesn't contain the Heroku AppLink Service Mesh binary"
            echo " !     Please configure 'heroku-applink-service-mesh' to start your web app, e.g.:"
            echo " !     web: heroku-applink-service-mesh ${WEB_COMMAND}"
        fi
    fi
else
    echo " !     Procfile not found at ${APP_DIR}/Procfile"
    echo " !     Please add the following to your Procfile:"
    echo " !     web: heroku-applink-service-mesh <your app startup command>"
fi

echo "-----> Done!"

