#!/usr/bin/env bash

set -euo pipefail

# CNB buildpack specific variables
LAYERS_DIR="$1"
PLATFORM_DIR="$2"
APP_DIR="/workspace"

echo "-----> Installing Heroku AppLink Service Mesh..."

# Create layers directory structure
LAYER_DIR="${LAYERS_DIR}/service-mesh"
mkdir -p "$LAYER_DIR"

# Read allowed environment variables from platform directory
if [ -f "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET" ]; then
    HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET=$(cat "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET")
    export HEROKU_APPLINK_SERVICE_MESH_S3_BUCKET
fi

if [ -f "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION" ]; then
    HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION=$(cat "${PLATFORM_DIR}/env/HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION")
    export HEROKU_APPLINK_SERVICE_MESH_RELEASE_VERSION
fi

BUILDPACK_DIR=$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)
source "${BUILDPACK_DIR:?}/lib/applink_installer.sh"

# Get current ETag from S3 to check for changes
S3_URL=$(get_binary_s3_url)
CURRENT_ETAG=$(curl -sI "$S3_URL" 2>/dev/null | grep -i '^etag:' | sed 's/^etag: *//i' | tr -d '"' | tr -d '\r' || echo "")
if [ -n "$CURRENT_ETAG" ] && [ -f "${LAYER_DIR}.toml" ]; then
    # Check if we can reuse the existing layer
    CACHED_ETAG=$(grep "etag = " "${LAYER_DIR}.toml" | cut -d'"' -f2 2>/dev/null || echo "")

    # Check if binary exists and ETAG matches
    if [ -f "${LAYER_DIR}/bin/heroku-applink-service-mesh" ] && \
       [ "$CACHED_ETAG" = "$CURRENT_ETAG" ]; then
        echo "-----> Reusing cached Heroku AppLink Service Mesh"
        REUSING_CACHE=true
    fi
fi

if [ "${REUSING_CACHE:-false}" = "false" ]; then
    # Install binary to layer bin directory (automatically added to PATH)
    mkdir -p "${LAYER_DIR}/bin"
    if ! install_applink_binary "${LAYER_DIR}/bin"; then
        echo " !     Failed to install Heroku AppLink Service Mesh binary"
        exit 1
    fi
fi

# Create/update layer metadata
cat > "${LAYER_DIR}.toml" << EOL
[types]
launch = true
build = false
cache = true

[metadata]
etag = "${CURRENT_ETAG}"
EOL


# Read web process from Procfile
echo "-----> Reading web process from Procfile..."
if [ -f "${APP_DIR}/Procfile" ]; then
    WEB_COMMAND=$(grep "^web:" "${APP_DIR}/Procfile" | sed 's/^web: //')
    if [ -z "$WEB_COMMAND" ]; then
        echo " !     No web process found in Procfile"
        echo " !     Please add the following to your Procfile:"
        echo " !     web: heroku-applink-service-mesh <your app startup command>"
    else
        # Check if web command already contains the binary name
        if [[ "$WEB_COMMAND" == *"heroku-applink-service-mesh"* ]]; then
            echo " !     Web process already contains the heroku-applink-service-mesh binary name"
        else
        # Create launch.toml to set the start command
        cat > "${LAYERS_DIR}/launch.toml" << EOL
[[processes]]
type = "web"
command = ["heroku-applink-service-mesh", "${WEB_COMMAND}"]
EOL
            echo "-----> Command to be executed: heroku-applink-service-mesh ${WEB_COMMAND}"
            echo "-----> The service mesh will automatically wrap your web process at runtime"
        fi
    fi
else
    echo " !     Procfile not found at ${APP_DIR}/Procfile"
    echo " !     Please add the following to your Procfile:"
    echo " !     web: heroku-applink-service-mesh <your app startup command>"
fi

echo "-----> Done!"

